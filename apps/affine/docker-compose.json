{
    "schemaVersion": 2,
    "services": [
        {
            "name": "affine_server",
            "image": "ghcr.io/toeverything/affine:${AFFINE_REVISION:-stable}",
            "environment": [
                {
                    "key": "REDIS_SERVER_HOST",
                    "value": "redis"
                },
                {
                    "key": "DATABASE_URL",
                    "value": "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE:-affine}"
                },
                {
                    "key": "AFFINE_INDEXER_ENABLED",
                    "value": "false"
                }
            ],
            "internalPort": 3010,
            "volumes": [
                {
                    "hostPath": "${UPLOAD_LOCATION}",
                    "containerPath": "/root/.affine/storage",
                    "readOnly": false,
                    "shared": false,
                    "private": false
                },
                {
                    "hostPath": "${CONFIG_LOCATION}",
                    "containerPath": "/root/.affine/config",
                    "readOnly": false,
                    "shared": false,
                    "private": false
                }
            ],
            "dependsOn": {
                "redis": {
                    "condition": "service_healthy"
                },
                "postgres": {
                    "condition": "service_healthy"
                },
                "affine_migration": {
                    "condition": "service_completed_successfully"
                }
            }
        },
        {
            "name": "affine_migration_job",
            "image": "ghcr.io/toeverything/affine:${AFFINE_REVISION:-stable}",
            "command": [
                "sh",
                "-c",
                "node ./scripts/self-host-predeploy.js"
            ],
            "environment": [
                {
                    "key": "REDIS_SERVER_HOST",
                    "value": "redis"
                },
                {
                    "key": "DATABASE_URL",
                    "value": "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE:-affine}"
                },
                {
                    "key": "AFFINE_INDEXER_ENABLED",
                    "value": "false"
                }
            ],
            "volumes": [
                {
                    "hostPath": "${UPLOAD_LOCATION}",
                    "containerPath": "/root/.affine/storage",
                    "readOnly": false,
                    "shared": false,
                    "private": false
                },
                {
                    "hostPath": "${CONFIG_LOCATION}",
                    "containerPath": "/root/.affine/config",
                    "readOnly": false,
                    "shared": false,
                    "private": false
                }
            ],
            "dependsOn": {
                "postgres": {
                    "condition": "service_healthy"
                },
                "redis": {
                    "condition": "service_healthy"
                }
            }
        },
        {
            "name": "affine_redis",
            "image": "redis",
            "healthCheck": {
                "test": "CMD redis-cli --raw incr ping",
                "interval": "10s",
                "timeout": "5s",
                "retries": 5
            }
        },
        {
            "name": "affine_postgres",
            "image": "pgvector/pgvector:pg16",
            "environment": [
                {
                    "key": "POSTGRES_USER",
                    "value": "${DB_USERNAME}"
                },
                {
                    "key": "POSTGRES_PASSWORD",
                    "value": "${DB_PASSWORD}"
                },
                {
                    "key": "POSTGRES_DB",
                    "value": "${DB_DATABASE:-affine}"
                },
                {
                    "key": "POSTGRES_INITDB_ARGS",
                    "value": "--data-checksums"
                },
                {
                    "key": "POSTGRES_HOST_AUTH_METHOD",
                    "value": "trust"
                }
            ],
            "volumes": [
                {
                    "hostPath": "${DB_DATA_LOCATION}",
                    "containerPath": "/var/lib/postgresql/data",
                    "readOnly": false,
                    "shared": false,
                    "private": false
                }
            ],
            "healthCheck": {
                "test": "CMD pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE:-affine}",
                "interval": "10s",
                "timeout": "5s",
                "retries": 5
            }
        }
    ]
}