{
    "services": [
        {
            "name": "affine",
            "image": "ghcr.io/toeverything/affine:${AFFINE_REVISION}",
            "isMain": true,
            "internalPort": 3010,
            "dependsOn": {
                "redis": {
                    "condition": "service_healthy"
                },
                "postgres": {
                    "condition": "service_healthy"
                },
                "affine_migration": {
                    "condition": "service_completed_successfully"
                }
            },
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/storage",
                    "containerPath": "/root/.affine/storage"
                },
                {
                    "hostPath": "${APP_DATA_DIR}/config",
                    "containerPath": "/root/.affine/config"
                }
            ],
            "environment": {
                "REDIS_SERVER_HOST": "redis",
                "DATABASE_URL": "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE}",
                "AFFINE_INDEXER_ENABLED": "false",
                "AFFINE_SERVER_HTTPS": "${AFFINE_SERVER_HTTPS}",
                "AFFINE_SERVER_HOST": "${AFFINE_SERVER_HOST}",
                "AFFINE_SERVER_EXTERNAL_URL": "${AFFINE_SERVER_EXTERNAL_URL}"
            }
        },
        {
            "name": "affine_migration",
            "image": "ghcr.io/toeverything/affine:${AFFINE_REVISION}",
            "command": [
                "sh",
                "-c",
                "node ./scripts/self-host-predeploy.js"
            ],
            "dependsOn": {
                "postgres": {
                    "condition": "service_healthy"
                },
                "redis": {
                    "condition": "service_healthy"
                }
            },
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/storage",
                    "containerPath": "/root/.affine/storage"
                },
                {
                    "hostPath": "${APP_DATA_DIR}/config",
                    "containerPath": "/root/.affine/config"
                }
            ],
            "environment": {
                "REDIS_SERVER_HOST": "redis",
                "DATABASE_URL": "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE}",
                "AFFINE_INDEXER_ENABLED": "false",
                "AFFINE_SERVER_HTTPS": "${AFFINE_SERVER_HTTPS}",
                "AFFINE_SERVER_HOST": "${AFFINE_SERVER_HOST}",
                "AFFINE_SERVER_EXTERNAL_URL": "${AFFINE_SERVER_EXTERNAL_URL}"
            }
        },
        {
            "name": "redis",
            "image": "redis",
            "healthCheck": {
                "test": "redis-cli --raw incr ping",
                "interval": "10s",
                "timeout": "5s",
                "retries": 5
            }
        },
        {
            "name": "postgres",
            "image": "pgvector/pgvector:pg16",
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/postgres",
                    "containerPath": "/var/lib/postgresql/data"
                }
            ],
            "environment": {
                "POSTGRES_USER": "${DB_USERNAME}",
                "POSTGRES_PASSWORD": "${DB_PASSWORD}",
                "POSTGRES_DB": "${DB_DATABASE}",
                "POSTGRES_INITDB_ARGS": "--data-checksums",
                "POSTGRES_HOST_AUTH_METHOD": "trust"
            },
            "healthCheck": {
                "test": "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}",
                "interval": "10s",
                "timeout": "5s",
                "retries": 5
            }
        }
    ]
}